# Final Architecture: REST API v1 + Resource Policies + NLB (v1.0.0)

**Date**: 2025-11-30
**Status**: Recommended Architecture for Production

## Executive Summary

After extensive analysis of HTTP API v2 + WAF vs REST API v1 + Resource Policies, the **REST API v1 architecture is the correct choice** for cost-conscious customers requiring IP filtering.

**Key Decision**: Use REST API v1 with native resource policies for IP filtering instead of HTTP API v2 + WAF. This saves **$5.10/month** while providing the strongly-encouraged security feature (IP allowlisting) at no additional cost.

---

## Critical Requirements

1. ECS Fargate running in a private VPC
2. Public endpoint with an AWS-generated certificate
3. **IP allowlisting strongly encouraged** (primary security recommendation)
4. Benchling HMAC Authorization requires verifying signature over raw request body
5. **Cost-conscious customers** (minimize infrastructure costs)

---

## Final Architecture (v1.0.0)

```text
Internet
  ↓
REST API Gateway v1
  • Resource policy for IP allowlisting (FREE)
  • CloudWatch access logs
  • No Lambda Authorizer (HMAC in FastAPI)
  ↓
VPC Link
  • Private connection into VPC
  ↓
Network Load Balancer (Internal)
  • TCP listener on port 80
  • Target Group: ECS tasks (IP mode)
  • Health checks: HTTP /health every 30s
  ↓
ECS Fargate Tasks (Private Subnets)
  • FastAPI application on port 8080
  • HMAC signature verification (authentication layer)
  • Business logic: S3/SQS operations
  ↓
External Services
  • S3 (package storage)
  • SQS (Quilt package queue)
  • Secrets Manager (Benchling credentials)
```

---

## Request Flow

### Successful Request

```text
1. Benchling → HTTPS POST with HMAC signature
2. REST API → Check source IP against resource policy
   → In allowlist → ALLOW
   → Not in allowlist → 403 Forbidden at edge
3. VPC Link → Network Load Balancer
4. NLB → Route to healthy ECS task
5. FastAPI → Verify HMAC(secret, body) == signature
   → Valid? Process webhook, write S3/SQS
   → Invalid? Return 403 Forbidden
6. Return 200 OK to Benchling
```

### Blocked by Resource Policy (IP Filtering)

```text
1. Unknown IP → POST
2. REST API → IP not in resource policy allowlist → BLOCK
3. Return 403 Forbidden at edge (never reaches VPC)
```

### Blocked by FastAPI HMAC Verification

```text
1. Request passes resource policy (IP in allowlist)
2. REST API → VPC Link → NLB → ECS
3. FastAPI → Verify HMAC signature → Invalid
4. Return 403 Forbidden
5. Log failed authentication attempt
```

---

## Security Model

### Two-Layer Defense

**Layer 1: REST API Resource Policy (Network Layer)**

- IP-based allowlisting at AWS edge (free)
- Blocks unknown IPs before reaching VPC (cost savings)
- Does NOT perform authentication (IP ≠ identity)
- Always deployed when IP allowlist configured

**Layer 2: FastAPI HMAC Verification (Authentication Layer)**

- All webhook requests MUST have valid HMAC signatures
- FastAPI uses Benchling SDK to verify signatures
- Verifies authenticity of webhook sender
- Cannot be done in Lambda Authorizer (body access required)

### Why No Lambda Authorizer?

Lambda Authorizers cannot verify HMAC signatures because:

1. They cannot access the raw request body needed for HMAC computation
2. API Gateway base64-encodes the body before passing to Lambda
3. HMAC must be computed over the exact bytes Benchling sent
4. Base64 encoding changes the bytes, breaking signature verification

**This applies to BOTH REST API and HTTP API Lambda Authorizers.**

---

## Component Details

### REST API Gateway v1

**Configuration**:

- **Type**: Regional REST API (not HTTP API v2)
- **Stage**: Dynamic (dev/prod/staging)
- **Integration**: VPC Link to NLB
- **Authentication**: NONE (handled by FastAPI)
- **Resource Policy**: IP allowlist (when configured)

**Endpoints**:

- `POST /{stage}/webhook` - Main webhook endpoint (IP + HMAC protected)
- `GET /{stage}/health` - Health check (exempt from IP filtering)

**Resource Policy Example**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "execute-api:Invoke",
      "Resource": "execute-api:/*/*/*",
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": [
            "192.168.1.0/24",
            "10.0.0.0/8"
          ]
        }
      }
    }
  ]
}
```

**Logging**: CloudWatch access logs (`/aws/apigateway/benchling-webhook`)

### Network Load Balancer

- **Type**: Internal (non-internet-facing)
- **Listener**: TCP port 80
- **Target Group**:
  - Protocol: TCP
  - Port: 8080
  - Target Type: IP (ECS tasks)
  - Deregistration Delay: 30s
- **Health Check**:
  - Protocol: HTTP
  - Path: `/health`
  - Interval: 30s
  - Healthy threshold: 2
  - Unhealthy threshold: 3

**Why NLB**: Health checks natively integrate with ECS container health

### ECS Fargate Service

- **Subnets**: Private (2 AZs)
- **Auto-scaling**: 2-10 tasks
- **Task Definition**:
  - CPU: 0.25 vCPU
  - Memory: 0.5 GB
  - Port: 8080
  - Container health check: `curl -f http://localhost:8080/health`

### FastAPI Application

- **Port**: 8080
- **Authentication**: HMAC signature verification using Benchling SDK
- **Endpoints**:
  - `POST /webhook` - Process events (requires valid HMAC)
  - `GET /health` - Health check (no auth)
- **Dependencies**: S3, SQS, Secrets Manager

---

## Cost Analysis (us-east-1)

### Monthly Costs (1M requests/month)

| Component | Fixed Cost | Variable (per million) | Total @ 1M req |
|-----------|------------|----------------------|----------------|
| REST API v1 | $0.00 | $3.50 | $3.50 |
| Resource Policy | $0.00 | $0.00 | $0.00 |
| VPC Link | $0.00 | $0.00 | $0.00 |
| Network Load Balancer | $16.20 | $0.01 | $16.21 |
| ECS Fargate (2 tasks) | $14.50 | - | $14.50 |
| NAT Gateway | $32.40 | - | $32.40 |
| **Total** | **$63.10** | **$3.51** | **$66.61** |

### Comparison: REST API vs HTTP API + WAF

| Architecture | API Gateway | IP Filtering | Total @ 1M req/mo |
|--------------|-------------|--------------|-------------------|
| **REST API + Resource Policy** | $3.50 | $0.00 | **$66.61** |
| HTTP API + No WAF | $1.00 | $0.00 | $64.11 |
| HTTP API + WAF | $1.00 | $7.60 | $71.71 |

### Cost Analysis by Use Case

**When IP filtering is NOT required:**

- HTTP API (no WAF): **$64.11** - Cheapest
- REST API: $66.61 - Slightly more expensive (+$2.50)

**When IP filtering IS required (strongly encouraged):**

- REST API + Resource Policy: **$66.61** - Best value
- HTTP API + WAF: $71.71 - More expensive (+$5.10)

### Break-Even Analysis

REST API becomes cost-effective when:

1. IP filtering is required AND
2. Request volume < 3M requests/month

At 3M+ requests/month:

- REST API: $63.10 + (3 × $3.50) = $73.60
- HTTP API + WAF: $70.10 + (3 × $1.61) = $74.93

**Conclusion**: For most webhook deployments (<3M req/mo) with IP filtering, REST API saves money.

---

## Deployment Strategy

### Phase 1: Deploy REST API (Default)

```bash
npm run setup  # Configure IP allowlist (comma-separated IPs/CIDRs)
npm run deploy:dev --yes
```

**Configuration**:

```json
{
  "security": {
    "webhookAllowList": "192.168.1.0/24,10.0.0.0/8",
    "enableVerification": true
  }
}
```

**Behavior**:

- REST API deployed with resource policy
- Unknown IPs blocked at edge (free)
- Valid IPs reach FastAPI for HMAC validation
- No WAF deployed (saves $7/month)

### Phase 2: Discover Benchling IPs (Optional)

If Benchling IPs are unknown, deploy without allowlist first:

```bash
# Deploy without IP filtering
npm run setup  # Leave webhookAllowList empty
npm run deploy:dev --yes

# Monitor API Gateway access logs
aws logs tail /aws/apigateway/benchling-webhook --follow

# Extract source IPs from successful webhook requests
# Add to allowlist and redeploy
```

---

## Configuration

### Required Settings

```json
{
  "security": {
    "webhookAllowList": "192.168.1.0/24,10.0.0.0/8",
    "enableVerification": true
  },
  "deployment": {
    "apiType": "rest",
    "region": "us-east-1"
  }
}
```

### Health Check Exemption

The `/health` endpoint is automatically exempted from IP filtering:

```json
{
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "execute-api:Invoke",
      "Resource": "execute-api:/*/GET/*/health"
    },
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "execute-api:Invoke",
      "Resource": "execute-api:/*/*/*",
      "Condition": {
        "IpAddress": {
          "aws:SourceIp": ["192.168.1.0/24"]
        }
      }
    }
  ]
}
```

---

## Monitoring & Debugging

### CloudWatch Log Groups

- `/aws/apigateway/benchling-webhook` - API Gateway access logs (includes IP filtering decisions)
- `/ecs/benchling-webhook` - ECS container logs (includes HMAC verification)

### Key Metrics

**API Gateway**:

- `Count` - Total requests
- `4XXError` - Client errors (includes IP filtering blocks)
- `5XXError` - Server errors
- `Latency` - Request latency

**NLB**:

- `HealthyHostCount` - Healthy ECS tasks
- `UnHealthyHostCount` - Unhealthy ECS tasks
- `TargetResponseTime` - Backend latency

**ECS**:

- `CPUUtilization` - Task CPU usage
- `MemoryUtilization` - Task memory usage

### Debugging IP Filtering

**Check resource policy**:

```bash
aws apigateway get-rest-api --rest-api-id <api-id> --query 'policy'
```

**View blocked requests**:

```bash
aws logs tail /aws/apigateway/benchling-webhook --follow --filter-pattern '403'
```

**Test from allowed IP**:

```bash
curl -X POST https://xxx.execute-api.us-east-1.amazonaws.com/dev/webhook \
  -H "Content-Type: application/json" \
  -H "X-Benchling-Signature: ..." \
  -d '{"test": "data"}'
```

---

## Success Criteria

- [x] REST API deployed with resource policy
- [x] IP allowlist enforced at edge (403 for unknown IPs)
- [x] Health endpoints exempt from IP filtering
- [x] VPC Link points to REST API (not HTTP API)
- [x] NLB deployed with healthy targets
- [x] Valid HMAC signatures return 200 OK
- [x] Invalid HMAC signatures return 403 Forbidden
- [x] No WAF deployed (cost savings)
- [x] No Lambda Authorizer deployed (not needed)
- [x] Lower total cost vs HTTP API + WAF ($66.61 vs $71.71)

---

## Advantages of REST API v1 Architecture

### Cost Efficiency

- **$5.10/month cheaper** than HTTP API + WAF (at 1M req/mo)
- **Native IP filtering** (no $7/month WAF cost)
- **No additional operational overhead**

### Simplicity

- Single API Gateway construct (no WAF)
- Built-in resource policies (no custom WAF rules)
- Fewer CloudWatch log groups
- Less infrastructure to monitor

### Security

- IP filtering at AWS edge (before VPC)
- HMAC verification in FastAPI (authentication)
- Two-layer defense without complexity

### Operational Benefits

- Fewer moving parts (no WAF)
- Simpler troubleshooting (REST API logs only)
- Lower cost = easier to justify to customers
- Proven, mature API Gateway type

---

## When to Use HTTP API v2 Instead

Consider HTTP API v2 + WAF if:

1. ❌ IP filtering NOT required (save $2.50/month)
2. ✅ HTTP/2 performance is critical requirement
3. ✅ Request volume > 3M/month (cost break-even)
4. ✅ Modern API Gateway features needed (JWT authorizers, etc.)

For most webhook deployments: **REST API v1 is the better choice**.

---

## APPENDIX A: HTTP API v2 Architecture (Deprecated)

The v0.9.0 architecture used HTTP API v2 + WAF. This section documents why it was replaced.

### v0.9.0 Architecture (No Longer Recommended)

```text
Internet
  ↓
[Optional] AWS WAF (IP filtering)
  ↓
HTTP API Gateway v2
  ↓
VPC Link
  ↓
Network Load Balancer
  ↓
ECS Fargate (FastAPI HMAC)
```

### Why Deprecated

**Cost issue**: When IP filtering is required:

- HTTP API + WAF: $71.71/month
- REST API + Resource Policy: $66.61/month
- **Difference: +$5.10/month unnecessary cost**

**Complexity issue**:

- WAF requires separate construct
- Additional CloudWatch log group
- More infrastructure to monitor
- No benefit over REST API resource policies

**Customer requirement mismatch**:

- IP filtering is **strongly encouraged**
- Customers are **cost-conscious**
- HTTP API v2 optimized for neither requirement

### When HTTP API v2 Was Chosen

Initial analysis prioritized:

- Lower per-request cost ($1.00 vs $3.50)
- HTTP/2 performance benefits
- "Modern" API Gateway features

**Critical oversight**: Didn't account for required IP filtering cost ($7.60/month WAF).

---

## APPENDIX B: Broken Alternatives

### ❌ Lambda Authorizer for HMAC Verification

**Why attempted**: Defense-in-depth security

**Why broken**:

```python
# Lambda receives base64-encoded body
event['body'] = base64_encode(raw_request_body)

# HMAC must use exact bytes
benchling_signature = hmac(secret, raw_request_body)

# Lambda only has base64 version
computed_signature = hmac(secret, base64_decode(event['body']))

# Signatures NEVER match
computed_signature != benchling_signature  # Always fails
```

**Applies to**: REST API Lambda Authorizers AND HTTP API Lambda Authorizers

**Lesson**: Cannot verify body-based HMAC in Lambda Authorizer. Must be done in FastAPI.

---

### ❌ Cloud Map Service Discovery

**Why attempted**: Cost savings (no NLB)

**Why broken**:

```text
ECS Tasks → HEALTHY
Cloud Map Instances → UNHEALTHY (requires manual API calls)
VPC Link → No healthy targets
API Gateway → 500 Internal Server Error
```

**Lesson**: Cloud Map incompatible with ECS without custom health status updates.

---

### ❌ Application Load Balancer (ALB)

**Why viable but not chosen**:

- Works correctly with VPC Link + ECS
- HTTP health checks (same as NLB)
- Cost: $22/month vs $16.20 for NLB

**Why rejected**: +$6/month for features we don't need (path routing, host routing).

---

## Conclusion

The **REST API v1 + Resource Policies + NLB** architecture is the correct choice for v1.0.0:

1. ✅ **Lower cost** - $5.10/month less than HTTP API + WAF
2. ✅ **Native IP filtering** - Resource policies (free)
3. ✅ **Simpler architecture** - No WAF needed
4. ✅ **Meets customer requirements** - Cost-conscious with encouraged IP filtering
5. ✅ **Same security model** - HMAC verification in FastAPI
6. ✅ **Proven reliability** - NLB + ECS pattern from v0.8.x

**Next steps**: Implement REST API Gateway construct, migrate from HTTP API v2, update documentation.

---

**Version**: 1.0.0
**Date**: 2025-11-30
**Status**: Production Architecture
