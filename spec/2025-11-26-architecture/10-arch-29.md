# Final Architecture: HTTP API v2 + NLB (v0.9.0)

**Date**: 2025-11-29
**Status**: Recommended Final Design

## Critical Requirements

1. ECS Fargate running in a private VPC
2. Public endpoint with an AWS-generated certificate
3. Optional IP Whitelisting AT THE EDGE
4. Benchling HMAC Authorization requires verifying signature over BODY of request

---

## Summary Recommendation

After investigating Cloud Map health check failures (500 errors), the final v0.9.0 architecture uses:

- **WAF** - OPTIONAL conditional deployment for IP filtering when needed
- **HTTP API Gateway v2** - Modern API Gateway with VPC Link support
- **Network Load Balancer** - Internal load balancer with native ECS health checks
- **ECS Fargate** - Private application layer with FastAPI HMAC verification

**Key Decision:** No Lambda Authorizer - it cannot access raw request body needed for HMAC verification. All authentication happens in FastAPI.

---

## Final Architecture (Front to Back)

```text
Internet
  ↓
[OPTIONAL] AWS WAF
  • Only deployed when webhookAllowList is configured
  • Blocks unknown IPs at AWS edge (saves API Gateway cost)
  • Default action: BLOCK (deny-by-default)
  ↓
HTTP API Gateway v2
  • NO Lambda Authorizer (cannot access raw body for HMAC)
  • Direct VPC Link integration
  • CloudWatch access logs
  ↓
VPC Link
  • Private connection into VPC
  ↓
Network Load Balancer (Internal)
  • TCP listener on port 80
  • Target Group: ECS tasks (IP mode)
  • Health checks: HTTP /health every 30s
  • Native integration with ECS container health
  ↓
ECS Fargate Tasks (Private Subnets)
  • FastAPI application on port 8080
  • HMAC signature verification (ONLY authentication layer)
  • Business logic: S3/SQS operations
  • Container health checks: local HTTP /health
  ↓
External Services
  • S3 (package storage)
  • SQS (Quilt package queue)
  • Secrets Manager (Benchling credentials)
```

---

## Request Flow

### Successful Request

```text
1. Benchling → HTTPS POST with HMAC signature
2. [If WAF deployed] Check IP → In allowlist → ALLOW
3. HTTP API Gateway → Forward to VPC Link
4. VPC Link → Network Load Balancer
5. NLB → Route to healthy ECS task
6. FastAPI → Verify HMAC(secret, body) == signature
   → Valid? Process webhook, write S3/SQS
   → Invalid? Return 403 Forbidden
7. Return 200 OK to Benchling
```

### Blocked by WAF (Optional Layer)

```text
1. Unknown IP → POST
2. WAF → IP not in allowlist → BLOCK
3. Return 403 Forbidden at edge
4. Request NEVER reaches API Gateway, NLB, or ECS
```

### Blocked by FastAPI HMAC Verification

```text
1. Request passes WAF (or no WAF deployed)
2. HTTP API Gateway → VPC Link → NLB → ECS
3. FastAPI → Verify HMAC signature → Invalid
4. Return 403 Forbidden
5. Log failed authentication attempt
```

---

## Security Model

### Single Authentication Layer: FastAPI HMAC Verification

- All webhook requests MUST have valid HMAC signatures computed over raw request body
- FastAPI uses Benchling SDK to verify signatures against secret from Secrets Manager
- This is the ONLY layer that validates webhook authenticity

### Optional Network Layer: WAF IP Filtering

- Deploy WAF only when `webhookAllowList` is configured
- Blocks unknown IPs at AWS edge (cost savings)
- Does NOT perform authentication (IP ≠ identity)
- When not configured: No WAF deployed, saves $7/month

### Why No Lambda Authorizer?

Lambda Authorizers cannot verify HMAC signatures because:

1. They cannot access the raw request body needed for HMAC computation
2. HTTP API v2 base64-encodes the body before passing to Lambda
3. HMAC must be computed over the exact bytes Benchling sent
4. Base64 encoding changes the bytes, breaking signature verification

---

## Component Details

### HTTP API Gateway v2

- **Type**: HTTP API (not REST API)
- **Stage**: Dynamic (dev/prod/staging)
- **Integration**: VPC Link to NLB
- **Authentication**: NONE (handled by FastAPI)
- **Endpoints**:
  - `POST /{stage}/webhook` - Main webhook endpoint
  - `GET /{stage}/health` - Health check (no auth)
- **Logging**: CloudWatch access logs

### Network Load Balancer

- **Type**: Internal (non-internet-facing)
- **Listener**: TCP port 80
- **Target Group**:
  - Protocol: TCP
  - Port: 8080
  - Target Type: IP (ECS tasks)
  - Deregistration Delay: 30s
- **Health Check**:
  - Protocol: HTTP
  - Path: `/health`
  - Interval: 30s
  - Healthy threshold: 2
  - Unhealthy threshold: 3
- **Why NLB**: Health checks natively integrate with ECS container health

### ECS Fargate Service

- **Subnets**: Private (2 AZs)
- **Auto-scaling**: 2-10 tasks
- **Task Definition**:
  - CPU: 0.25 vCPU
  - Memory: 0.5 GB
  - Port: 8080
  - Container health check: `curl -f http://localhost:8080/health`

### FastAPI Application

- **Port**: 8080
- **Authentication**: HMAC signature verification using Benchling SDK
- **Endpoints**:
  - `POST /webhook` - Process events (requires valid HMAC)
  - `GET /health` - Health check (no auth)
- **Dependencies**: S3, SQS, Secrets Manager

### WAF (Conditional)

- **Deployment**: Only when `webhookAllowList` is configured
- **Scope**: Regional (us-east-1, etc.)
- **Rules**:
  1. Health check exception (always allow `/health*`)
  2. IP allowlist (BLOCK unknown IPs)
- **Default Action**: BLOCK (when deployed)
- **Logs**: `/aws/waf/benchling-webhook`

---

## Cost Analysis (us-east-1)

### Monthly Costs

| Component | Fixed Cost | Variable (per million requests) |
|-----------|------------|--------------------------------|
| HTTP API v2 | $0.00 | $1.00 |
| VPC Link | $0.00 | $0.00 |
| Network Load Balancer | $16.20 | $0.01 |
| ECS Fargate (2 tasks) | $14.50 | - |
| NAT Gateway | $32.40 | - |
| **Base Total (No WAF)** | **$63.10** | **$1.01** |
| **Add WAF** | **+$7.00** | **+$0.60** |
| **Total with WAF** | **$70.10** | **$1.61** |

### Comparison to Previous Versions

| Architecture | Fixed/Month | Variable/M | Total @ 1M req/mo |
|--------------|-------------|------------|-------------------|
| v0.8.x (REST API + Lambda + NLB) | $48.60 | $3.70 | $52.30 |
| v0.9.0 Cloud Map (BROKEN) | $46.90 | $1.20 | $48.10 |
| **v0.9.0 Final (HTTP + NLB)** | **$63.10** | **$1.01** | **$64.11** |
| **v0.9.0 Final + WAF** | **$70.10** | **$1.61** | **$71.71** |

**Trade-offs**:

- +$11.81/month vs v0.8.x, but eliminates Lambda complexity, lower latency
- +$16.01/month vs broken Cloud Map, but actually works
- WAF optional: Deploy only when IP filtering needed

---

## Deployment Strategy

### Phase 1: Deploy Without WAF (Recap)

```bash
npm run setup  # Leave webhookAllowList empty
npm run deploy:dev --yes
```

**Behavior**:

- No WAF deployed (saves $7/month)
- All requests reach FastAPI for HMAC validation
- Use for: Development, testing, initial production

### Phase 2: Add WAF (Optional)

```bash
# Edit config: Set webhookAllowList = "192.168.1.0/24,10.0.0.0/8"
npm run deploy:dev --yes
```

**Behavior**:

- WAF deployed with BLOCK mode
- Unknown IPs blocked at edge
- Use for: Production with known Benchling IPs

---

## Migration from v0.9.0 (Cloud Map)

### What Changes

**Removed**:

- Cloud Map service discovery
- Cloud Map namespace
- `HttpServiceDiscoveryIntegration` in API Gateway

**Added**:

- Network Load Balancer (internal)
- Target Group (ECS tasks, IP mode)
- NLB health checks (HTTP /health)
- VPC Link now points to NLB (not Cloud Map)

**Unchanged**:

- HTTP API v2 Gateway
- ECS Fargate service
- FastAPI application
- WAF configuration

### Migration Steps

1. Deploy NLB + Target Group (no traffic yet)
2. Wait for NLB to show healthy targets
3. Update VPC Link integration to point to NLB
4. Remove Cloud Map service
5. Verify end-to-end traffic flow

---

## Success Criteria

- [ ] NLB deployed with healthy targets
- [ ] VPC Link points to NLB (not Cloud Map)
- [ ] Valid HMAC signatures return 200 OK
- [ ] Invalid HMAC signatures return 403 Forbidden
- [ ] WAF NOT deployed when webhookAllowList empty
- [ ] WAF deployed and blocks IPs when webhookAllowList configured
- [ ] Health endpoints work without authentication
- [ ] No 500 errors (Cloud Map issue resolved)
- [ ] No Lambda Authorizer deployed

---

## APPENDIX A: Viable Alternatives (Not Chosen)

### Option 1: Application Load Balancer (ALB) Instead of NLB

**Architecture**:

```text
HTTP API v2 → VPC Link → ALB → ECS (FastAPI HMAC verification)
```

**Why viable**:

- ✅ ALB supports HTTP health checks (native ECS integration)
- ✅ ALB supports path-based routing, host-based routing
- ✅ Same authentication model (FastAPI HMAC verification)
- ✅ Actually works

**Why not chosen**:

- Higher cost: ~$22/month (vs $16.20 for NLB)
- Unnecessary features: Don't need path routing, host routing, WAF integration
- VPC Link works with both NLB and ALB equally

**Verdict**: Works, but costs +$6/month for features we don't use

---

### Option 2: REST API v1 + Resource Policies (Native IP Filtering)

**Architecture**:

```text
REST API v1 (with resource policy) → VPC Link → NLB → ECS (FastAPI HMAC verification)
```

**Why viable**:

- ✅ Native IP filtering via resource policies (FREE)
- ✅ No WAF cost ($7/month saved)
- ✅ Same VPC Link + NLB + ECS pattern
- ✅ Same FastAPI HMAC authentication
- ✅ Actually works

**Cost comparison (1M requests/month)**:

| Architecture | API Gateway | IP Filtering | Total |
|--------------|-------------|--------------|-------|
| **REST API + Resource Policy** | $3.50 | $0 (native) | **$3.50** |
| HTTP API + No WAF | $1.00 | $0 (none) | $1.00 |
| HTTP API + WAF | $1.00 | $7.60 | $8.60 |

**Why not chosen**:

Initial architecture prioritized HTTP API v2 for:

- Lower per-request cost ($1.00 vs $3.50)
- HTTP/2 performance benefits
- Modern API Gateway features

However, this overlooked a critical trade-off:

**If IP filtering is required (as strongly encouraged):**

- REST API + Resource Policy: **$3.50/month total**
- HTTP API + WAF: **$8.60/month total**
- **REST API saves $5.10/month when IP filtering needed**

**When to reconsider REST API**:

1. ✅ IP filtering is required or strongly encouraged
2. ✅ Customers are cost-conscious
3. ✅ Request volume < 3M/month (below WAF cost break-even)
4. ✅ HTTP/2 not a hard requirement

**Migration effort**: Low

- Same VPC Link + NLB + ECS components
- Only API Gateway type changes
- Resource policy replaces WAF construct
- FastAPI unchanged (still does HMAC)

**Verdict**: **Should be reconsidered** for cost-conscious deployments requiring IP filtering. REST API + Resource Policies provide native IP filtering at $5.10/month less than HTTP API + WAF.

---

## APPENDIX B: Broken Alternatives (Cannot Work)

### ❌ ANY Lambda Authorizer for HMAC Verification

**Why attempted**: Defense-in-depth security, isolate authentication from business logic

**Why broken**:

```python
# Lambda receives base64-encoded body (both REST API and HTTP API v2)
event['body'] = base64_encode(raw_request_body)

# HMAC verification MUST use exact bytes Benchling sent
benchling_signature = hmac(secret, raw_request_body)

# Lambda only has base64-encoded version
computed_signature = hmac(secret, base64_decode(event['body']))

# Signatures will NEVER match
computed_signature != benchling_signature  # Always fails
```

**Root cause**: API Gateway (both REST and HTTP API v2) base64-encodes request body before passing to Lambda Authorizer. HMAC signatures must be computed over exact raw bytes. Base64 encoding changes the bytes, making signature verification impossible.

**Applies to**:

- ❌ REST API + Lambda Authorizer
- ❌ HTTP API v2 + Lambda Authorizer
- ❌ ANY API Gateway type + Lambda Authorizer for body-based HMAC

**Lesson**: Lambda Authorizers cannot verify HMAC signatures computed over request body. Period.

---

### ❌ Cloud Map Service Discovery (v0.9.0)

**Why attempted**: Cost savings (no NLB)

**Why broken**:

```text
ECS Tasks → HEALTHY (container checks passing)
Cloud Map Instances → UNHEALTHY (requires manual UpdateInstanceCustomHealthStatus API)
VPC Link → No healthy targets (queries Cloud Map)
API Gateway → 500 Internal Server Error
```

**Root cause**: CDK automatically adds `HealthCheckCustomConfig` to Cloud Map services. This requires application code to manually call AWS API to update health status. ECS only registers instances, doesn't update health.

**Attempted fixes that failed**:

- Adding/removing `failureThreshold` configuration
- Recreating Cloud Map service
- Force redeploying ECS tasks
- Disabling health checks (CDK always adds them)

**Lesson**: Cloud Map custom health checks incompatible with ECS unless application implements health status updates (architectural smell).

---

### ❌ REST API Resource Policies for IP Filtering (HTTP API v2)

**Why attempted**: Native IP filtering without WAF cost

**Why broken**:

```bash
aws apigatewayv2 update-api --api-id xxx --policy '...'
# Error: Unknown parameter 'policy'
```

**Root cause**: HTTP API v2 does NOT support resource policies. Only REST API (v1) supports them.

**Attempted workarounds**:

- IAM authorization: Requires AWS credentials (not suitable for webhooks)
- Lambda Authorizer IP check: Adds cost and complexity
- VPC endpoint policies: Doesn't apply to public endpoints

**Lesson**: HTTP API v2 has no native IP filtering. WAF is the only option.

---

### ❌ WAF "Discovery Mode" with COUNT Action

**Why attempted**: Discover Benchling IPs without blocking legitimate traffic

**Why broken**:

```text
WAF Rule: IP not in allowlist → COUNT (log but allow)
Result: ALL traffic allowed through
Security: Relies entirely on HMAC verification
Cost: $7/month for logging only
```

**Why this is wrong**:

- WAF deployed but provides no security value
- Paying $7/month just to log IPs
- Can discover IPs from API Gateway access logs (free)
- If not blocking, why deploy WAF?

**Correct approach**:

- Don't deploy WAF at all when `webhookAllowList` is empty
- Discover IPs from API Gateway access logs
- Deploy WAF only when ready to block

**Lesson**: Conditional deployment is better than COUNT mode. Don't pay for infrastructure that provides no value.

---

### ❌ ECS Service Discovery with DNS_ONLY (No Health Checks)

**Why attempted**: Avoid Cloud Map custom health check issues

**Why broken**:

```typescript
// CDK code
service.cloudMapOptions = {
  cloudMapNamespaceOptions: { type: 'DNS_ONLY' }
}

// Result: CDK error
Error: DNS_ONLY not supported with ECS service discovery
```

**Root cause**: ECS service discovery requires `DNS_HTTP` type with health checks. CDK always adds `HealthCheckCustomConfig`.

**Lesson**: Cannot use Cloud Map with ECS without custom health checks. Must use load balancer.

---

### ❌ VPC Link Direct to ECS Tasks (No Load Balancer)

**Why attempted**: Eliminate NLB cost

**Why broken**:

```text
VPC Link requires one of:
- Network Load Balancer
- Application Load Balancer
- Cloud Map service discovery

Cannot point directly to ECS task IPs (dynamic, ephemeral)
```

**Root cause**: VPC Link needs stable endpoint. ECS task IPs change on every deployment.

**Lesson**: VPC Link requires load balancer or service discovery. No way around it.

---

## Conclusion

The **HTTP API v2 + Network Load Balancer** architecture is the final v0.9.0 design. It provides:

1. ✅ **Working health checks** - NLB natively integrates with ECS
2. ✅ **Simple security model** - FastAPI HMAC verification only
3. ✅ **No Lambda complexity** - Direct API Gateway → VPC Link → NLB → ECS
4. ✅ **Optional WAF** - Deploy only when IP filtering needed
5. ✅ **Proven reliability** - NLB pattern worked in v0.8.x

**Trade-off**: +$16/month vs broken Cloud Map architecture, but eliminates 500 errors and provides working production service.

**Next steps**: Implement NLB + Target Group constructs, remove Cloud Map resources, deploy and verify.

**Date**: 2025-11-29  
**Status**: Recommended Final Design (Streamlined)

## 1. Core Requirements

1. ECS Fargate in private subnets  
2. Public HTTPS endpoint with AWS-managed certificate  
3. Optional IP allow-listing at the edge  
4. Benchling HMAC computed over raw request body

## 2. Final Architecture (v0.9.0)

```text
Internet
  ↓
[Optional] AWS WAF (edge IP filtering)
  ↓
HTTP API Gateway v2 (public)
  ↓
VPC Link (private)
  ↓
Network Load Balancer (internal)
  ↓
ECS Fargate Tasks (FastAPI w/ HMAC)
  ↓
S3 / SQS / Secrets Manager
```

**Rationale**  

- NLB gives reliable ECS health checks  
- HTTP API v2 is low-cost, low-latency  
- FastAPI is the only place that can read raw request body for HMAC  
- WAF is optional and deployed only when allowlist exists  

## 3. Security Model

## 3.1 Single Authentication Layer: FastAPI HMAC Verification

- HMAC computed over raw request bytes  
- FastAPI reads unmodified body → only place where verification is possible  
- Returns 200 on success; 403 on invalid signature

## 3.2 Optional Network Layer: WAF IP Filtering

- Applied only when allowlist configured  
- Default action: BLOCK  
- Reduces API Gateway traffic for unknown IPs  
- Not an authentication method

## 4. Key Architectural Decisions

## 4.1 No Lambda Authorizer

- API Gateway encodes body before invoking Lambda  
- HMAC must use exact bytes sent by Benchling  
- Base64-encoded body is not identical → signature never matches  

## 4.2 NLB Instead of Cloud Map or ALB

- NLB integrates natively with ECS health checks  
- Cloud Map requires custom health updates → incompatible with ECS-only approach  
- ALB works but adds cost and features not needed (routing, host rules)

## 4.3 HTTP API v2 Instead of REST API

- Cheaper and faster  
- Direct VPC Link support  
- REST API resource policies not needed

## 5. Request Flows

## 5.1 Successful Request

1. Benchling → POST + HMAC  
2. [Optional] WAF checks IP  
3. HTTP API → VPC Link → NLB  
4. ECS task receives request  
5. FastAPI validates HMAC → processes event → returns 200

## 5.2 Blocked by WAF

Unknown IP → WAF blocks → 403 at edge

## 5.3 Blocked by FastAPI HMAC

Invalid signature → FastAPI returns 403

## 6. Health Checks

- NLB → `/health` on ECS tasks  
- Container health check → local `/health`  
- API Gateway → `/health` (public, no auth)

## 7. Deployment Strategy

### Phase 1: Deploy Without WAF

- No allowlist → WAF omitted  
- Ideal for dev/staging/initial production

## Phase 2: Enable WAF (Optional)

- Add IP allowlist → redeploy  
- Blocks unknown sources at edge

## 8. Cost Overview (us-east-1)

Base (no WAF): ~**$63/month**  
With WAF: ~**$70/month**  
Variable: ~$1 per million requests  
Trade-off: Slightly higher than Cloud Map, but stable and production-ready.

## 9. Migration From Cloud Map

1. Deploy NLB + target group  
2. Ensure healthy ECS targets  
3. Point VPC Link to NLB  
4. Remove Cloud Map resources  
5. Verify HMAC end-to-end

## 10. Conclusion

This architecture minimizes components while maintaining reliability:

- Proven NLB + ECS pattern  
- Single HMAC-based authentication  
- HTTP API v2 for cost/latency advantages  
- Optional WAF for IP filtering  
- No Lambda and no Cloud Map complexity  

It represents the simplest reliable architecture that meets all functional and security requirements.
