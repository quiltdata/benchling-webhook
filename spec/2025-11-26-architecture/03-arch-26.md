# Benchling Webhook Architecture (v1.0.0)

**Date**: 2025-11-26
**Status**: Planned
**Architecture**: Defense-in-Depth Security with Lambda Authorizer

## Overview

The Benchling webhook integration implements a three-layer defense-in-depth security architecture:

1. **Network Layer**: IP filtering via REST API Gateway resource policies
2. **Authentication Layer**: Lambda Authorizer performing HMAC signature verification
3. **Application Layer**: Private ECS Fargate tasks handling business logic

This architecture minimizes attack surface by isolating authentication logic in a Lambda function with minimal permissions (read access to one Secrets Manager secret only).

## Architecture Diagram

```diagram
Internet
    ↓
┌─────────────────────────────────────┐
│ REST API Gateway (REGIONAL)         │
│ - IP resource policy (CIDR filter)  │
│ - Rate limiting / throttling        │
│ - CloudWatch access logs            │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Lambda Authorizer                   │
│ - HMAC signature verification       │
│ - Benchling SDK integration         │
│ - IAM: secretsmanager:GetSecretValue│
│   (ONE secret only)                 │
│ - Returns IAM policy (Allow/Deny)   │
└─────────────────────────────────────┘
    ↓ (authenticated requests only)
┌─────────────────────────────────────┐
│ VPC Link                            │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Network Load Balancer (internal)    │
│ - Target: ECS tasks (IP mode)       │
│ - Health checks: /health endpoint   │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ Private VPC                         │
│  ├─ ECS Fargate Service             │
│  │  - Private subnets (2 AZs)       │
│  │  - No public IP assignment       │
│  │  - Auto-scaling: 2-10 tasks      │
│  │  - Cloud Map service discovery   │
│  │  - FastAPI application (port 8080)
│  │                                   │
│  ├─ NAT Gateway (for ECS egress)    │
│  │                                   │
│  └─ Security Groups                 │
│     - ECS: allow 8080 from NLB only │
│     - NLB: allow 80 from VPC Link   │
└─────────────────────────────────────┘
    ↓
External Services
├─ S3: Package storage
├─ SQS: Quilt package creation queue
├─ Secrets Manager: Benchling credentials
└─ CloudWatch Logs: Application logs
```

## Request Flow

### Successful Request

1. Benchling → HTTPS POST to REST API Gateway
2. API Gateway: Check source IP against resource policy
   → If IP not in allowlist → 403 Forbidden
3. API Gateway: Invoke Lambda Authorizer
4. Lambda Authorizer:
   a. Retrieve Benchling app secret from Secrets Manager
   b. Verify HMAC signature using Benchling SDK
   c. Return IAM policy (Allow/Deny)
   → If invalid signature → 401 Unauthorized
5. API Gateway: Forward to VPC Link (only if authorized)
6. VPC Link → NLB → ECS Fargate task
7. FastAPI: Process webhook event (NO authentication needed)
8. FastAPI: Create Quilt package via S3 + SQS
9. Return 200 OK to Benchling

### Failed Authentication

1. Benchling → HTTPS POST
2. API Gateway: Check IP → Pass (or 403)
3. Lambda Authorizer: Verify HMAC → Fail
4. Lambda Authorizer: Return Deny policy
5. API Gateway: Return 401 Unauthorized
6. Request NEVER reaches ECS

## Components

### REST API Gateway

- **Type**: Regional REST API (not HTTP API v2)
- **Stage**: `prod`
- **IP Filtering**: IAM resource policy with CIDR allowlist
- **Authentication**: Lambda Authorizer (REQUEST type)
- **Endpoints**:
  - `POST /prod/webhook` - Main webhook endpoint
  - `GET /prod/health` - Health check (no auth)
- **Logging**: CloudWatch access logs (JSON format)
- **Rate Limiting**: API Gateway throttling (configurable)

### Lambda Authorizer

- **Runtime**: Python 3.11
- **Memory**: 128 MB
- **Timeout**: 10 seconds
- **Handler**: `index.handler`
- **Dependencies**: `benchling-sdk` (HMAC verification)
- **Environment Variables**:
  - `BENCHLING_SECRET_ARN`: Secrets Manager ARN (secret contains `app_definition_id` field)
- **IAM Permissions**: `secretsmanager:GetSecretValue` (single secret only)
- **Identity Sources**:
  - `webhook-id` header
  - `webhook-signature` header
  - `webhook-timestamp` header
- **Caching**: Disabled (`resultsCacheTtl: 0`)

### Network Load Balancer

- **Type**: Internal (non-internet-facing)
- **Subnets**: Private subnets (2 AZs)
- **Target Group**:
  - Protocol: TCP
  - Port: 8080
  - Target Type: IP
  - Deregistration Delay: 30s
- **Health Check**:
  - Protocol: HTTP
  - Path: `/health`
  - Interval: 30s
  - Timeout: 10s
  - Healthy threshold: 2
  - Unhealthy threshold: 3

### ECS Fargate Service

- **Cluster**: `benchling-webhook-cluster`
- **Service**: `benchling-webhook-service`
- **Task Definition**:
  - CPU: 0.25 vCPU
  - Memory: 0.5 GB
  - Platform: Linux/x86_64
  - Networking: awsvpc mode
- **Auto-scaling**:
  - Min tasks: 2
  - Max tasks: 10
  - Target: CPU 70% or request count
- **Service Discovery**: AWS Cloud Map (private DNS)
- **Deployment**:
  - Type: Rolling update
  - Min healthy: 100%
  - Max healthy: 200%

### FastAPI Application

- **Container Port**: 8080
- **Framework**: FastAPI + Uvicorn
- **Endpoints**:
  - `POST /webhook` - Process Benchling events (NO auth - handled by Lambda)
  - `GET /health` - Health check
  - `GET /health/ready` - Readiness probe
- **Logging**: Structured JSON logs to CloudWatch
- **Dependencies**:
  - `benchling-sdk`: Benchling API client (NOT for HMAC verification)
  - `boto3`: AWS SDK (S3, SQS, Secrets Manager)
  - `quilt3`: Quilt package creation

## Security Model

### Defense-in-Depth Layers

#### Layer 1 - Network Filtering**

- IP resource policy on REST API Gateway
- Blocks non-whitelisted IPs at AWS edge
- No compute cost for blocked requests
- Configuration: `security.webhookAllowList` (comma-separated CIDRs)

#### Layer 2 - Authentication**

- Lambda Authorizer with minimal permissions
- Performs HMAC verification using Benchling SDK
- **CRITICAL**: Lambda has ZERO access to:
  - Database
  - S3 buckets
  - SQS queues
  - Business logic
- **ONLY** permission: Read ONE Secrets Manager secret
- If compromised: Attacker gains signature validation only

#### Layer 3 - Business Logic**

- Private ECS tasks in isolated VPC
- Receives ONLY authenticated requests
- Full AWS service access for legitimate operations
- Never directly exposed to internet

### Attack Surface Analysis

**Without Lambda Authorizer** (rejected):

- API Gateway → ECS (ECS has full AWS permissions)
- Compromised ECS = Full system compromise

**With Lambda Authorizer** (implemented):

- API Gateway → Lambda (minimal permissions) → ECS (full permissions)
- Compromised Lambda = Signature validation only
- Compromised ECS = Pre-authenticated requests only
- Both layers must be breached for significant impact

## Configuration

### Profile Configuration

```json
{
  "security": {
    "webhookAllowList": "192.168.1.0/24,10.0.0.0/8",
    "enableVerification": true
  },
  "benchling": {
    "tenant": "example",
    "clientId": "...",
    "secretArn": "arn:aws:secretsmanager:us-east-1:123456789012:secret:benchling-webhook-xyz",
    "appDefinitionId": "app_..."
  },
  "deployment": {
    "region": "us-east-1",
    "imageTag": "1.0.0",
    "vpc": {
      "vpcId": "vpc-..."
    }
  }
}
```

### Secrets Manager

```json
{
  "client_id": "...",
  "client_secret": "...",
  "tenant": "example"
}
```

## Infrastructure Components

### VPC Configuration

- **Type**: Auto-created or existing
- **Subnets**: Private subnets with NAT Gateway (minimum 2 AZs)
- **CIDR**: Default or customer-specified
- **Requirements**:
  - Private subnets for ECS tasks
  - NAT Gateway for ECS egress to AWS services
  - Route tables configured for private subnet internet access

### Deployment Tracking

- **Location**: `~/.config/benchling-webhook/{profile}/deployments.json`
- **Per-profile**: Each profile tracks its own deployments
- **Information**:
  - Webhook endpoint URL
  - Image tag deployed
  - Deployment timestamp
  - Stack name and region

## Cost Estimate (us-east-1, 24/7 operation)

### Fixed Monthly Costs

- REST API Gateway: ~$0 (fixed) + $3.50/million requests
- Lambda Authorizer: ~$0 (fixed) + $0.20/million invocations
- Network Load Balancer: ~$16.20/month
- NAT Gateway: ~$32.40/month
- ECS Fargate (0.25 vCPU, 0.5 GB): ~$14.50/month
- Secrets Manager: ~$0.40/month
- CloudWatch Logs: ~$0.50/GB ingested

**Total Base Cost**: ~$64/month (no traffic)

### Variable Costs (per million requests)

- REST API Gateway: ~$3.50
- Lambda Authorizer: ~$0.20
- Data Transfer: ~$0.09/GB out

**Total per-million-requests**: ~$3.70

### Comparison to HTTP API (rejected)

- HTTP API would save ~$19/month (NLB + REST API premium)
- Trade-off: No IP resource policy support, less security isolation
- Customer requirement: Security > Cost

## Operational Considerations

### Monitoring

- **CloudWatch Metrics**:
  - API Gateway: Request count, 4xx/5xx errors, latency
  - Lambda: Invocation count, duration, errors, throttles
  - NLB: Target health, request count, connection errors
  - ECS: CPU/memory utilization, task count
- **CloudWatch Logs**:
  - API Gateway access logs: `/aws/apigateway/benchling-webhook-rest`
  - Lambda logs: `/aws/lambda/BenchlingWebhookAuthorizer`
  - ECS logs: `/ecs/benchling-webhook`

### Scaling

- **Lambda**: Automatic (up to account concurrency limit)
- **ECS**: Auto-scaling based on CPU (70% target) and request count
- **API Gateway**: Automatic (throttling configurable)
- **NLB**: Automatic capacity scaling

### Disaster Recovery

- **RPO**: 0 (stateless architecture)
- **RTO**: ~5 minutes (deploy to new region)
- **Dependencies**:
  - Multi-region S3 replication (Quilt packages)
  - Secrets Manager replication (Benchling credentials)
  - DNS update for new API Gateway endpoint

### Security Maintenance

- **Secret Rotation**: Automated via Secrets Manager (30-90 days)
- **Image Scanning**: ECR automatic scanning for vulnerabilities
- **Dependency Updates**: Automated via Dependabot
- **IAM Review**: Quarterly review of Lambda/ECS permissions

## Migration from v0.9.0

### Breaking Changes

1. **Authentication moved to Lambda**: HMAC verification no longer in FastAPI
2. **New component**: Lambda Authorizer function added
3. **Endpoint change**: `/webhook` → `/prod/webhook` (includes stage)

### Deployment Steps

1. Deploy Lambda Authorizer function
2. Update REST API Gateway with authorizer attachment
3. Deploy new ECS task definition (HMAC verification removed)
4. Update Benchling webhook URL to include `/prod` stage
5. Test authentication flow with valid/invalid signatures

### Rollback Plan

1. Detach Lambda Authorizer from API Gateway methods
2. Redeploy previous ECS task definition (with HMAC in FastAPI)
3. Revert Benchling webhook URL

## References

- AWS REST API Gateway: <https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-rest-api.html>
- Lambda Authorizers: <https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html>
- Benchling SDK: <https://github.com/benchling/benchling-sdk>
- AWS Well-Architected Security Pillar: <https://docs.aws.amazon.com/wellarchitected/latest/security-pillar/>
