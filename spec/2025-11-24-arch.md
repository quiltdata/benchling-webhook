# v0.9.0 Architecture Migration: Standalone → Integrated Pattern

## Executive Summary

Migrate standalone BenchlingWebhookStack from **API Gateway REST → ALB → ECS** to **API Gateway HTTP → VPC Link → Cloud Map → ECS**. This eliminates ALB overhead while maintaining HTTPS via API Gateway, using VPC Link for direct service discovery.

**Status**: Breaking changes acceptable (v0.9.0)
**Goal**: Architectural consistency + simplified infrastructure

---

## Current vs Target Architecture

### Current (v0.8.x)

```
API Gateway (REST) → ALB → ECS Fargate
                            └── Flask (port 5000)

Logs: BenchlingWebhookStack
      └── benchling-webhook/{taskId}
```

### Target (v0.9.0)

```
API Gateway (HTTP v2) → VPC Link → Cloud Map → ECS Fargate
                                                └── Flask (port 8080)

Logs: BenchlingWebhookStack
      └── benchling-webhook/{taskId}
```

**Rationale**:

- ALB is unnecessary overhead (API Gateway provides HTTPS)
- VPC Link + Cloud Map simpler than ALB target groups
- HTTP API v2 faster and cheaper than REST API
- Single container architecture (simpler, lower cost)
- API Gateway already handles rate limiting and routing

---

## Breaking Changes (v0.9.0)

1. **Stack Recreation Required**: REST API → HTTP API (cannot update in-place)
2. **Endpoint URL Changes**: New API Gateway URL format
3. **Flask Port**: 5000 → 8080 (Cloud Map standard)
4. **ALB Removed**: No direct ALB testing, all traffic via API Gateway

---

## Implementation Phases

### Phase 1: Update Flask Port and Remove ALB (2h)

**File**: `lib/fargate-service.ts`

**Changes**:

1. Update Flask container port: 5000 → 8080
2. Update Flask environment: `PORT=8080`
3. Remove ALB resources:
   - ALB (`this.loadBalancer`)
   - ALB logs S3 bucket (`albLogsBucket`)
   - Target group (`targetGroup`)
   - HTTP listener
   - ALB security groups

4. Add Cloud Map service discovery:
   - Create private DNS namespace: `benchling.local`
   - Register Flask container (port 8080)
   - DNS record type: A
   - TTL: 30s

5. Update security group: Allow inbound 8080 from VPC CIDR
6. Export `cloudMapService` for API Gateway integration

**Interface Changes**:

```typescript
export class FargateService extends Construct {
    public readonly service: ecs.FargateService;
    // REMOVED: public readonly loadBalancer: elbv2.ApplicationLoadBalancer;
    public readonly cloudMapService: servicediscovery.Service;  // NEW
    public readonly logGroup: logs.ILogGroup;
    public readonly cluster: ecs.Cluster;
}
```

---

### Phase 2: Replace REST API with HTTP API + VPC Link (3h)

**Files**:

- Rename: `lib/alb-api-gateway.ts` → `lib/http-api-gateway.ts`
- Update: `lib/benchling-webhook-stack.ts`

**New Construct**: `lib/http-api-gateway.ts`

```typescript
export class HttpApiGateway {
    public readonly api: apigatewayv2.HttpApi;
    public readonly vpcLink: apigatewayv2.VpcLink;
    public readonly logGroup: logs.ILogGroup;

    constructor(scope, id, props: {
        vpc: ec2.IVpc;
        cloudMapService: servicediscovery.IService;
        serviceSecurityGroup: ec2.ISecurityGroup;
        config: ProfileConfig;
    }) {
        // Create access log group
        this.logGroup = new logs.LogGroup(scope, "ApiGatewayAccessLogs", {
            logGroupName: "/aws/apigateway/benchling-webhook-http",
            retention: logs.RetentionDays.ONE_WEEK,
        });

        // Create VPC Link
        this.vpcLink = new apigatewayv2.VpcLink(scope, "VpcLink", {
            vpc: props.vpc,
            securityGroups: [props.serviceSecurityGroup],
            vpcLinkName: "benchling-webhook-vpclink",
        });

        // Create HTTP API
        this.api = new apigatewayv2.HttpApi(scope, "BenchlingWebhookHttpAPI", {
            apiName: "BenchlingWebhookHttpAPI",
            description: "HTTP API for Benchling webhook integration (v0.9.0+)",
        });

        // Cloud Map integration via VPC Link
        const integration = new apigatewayv2_integrations.HttpServiceDiscoveryIntegration(
            "CloudMapIntegration",
            props.cloudMapService,
            { vpcLink: this.vpcLink }
        );

        // Add routes
        this.api.addRoutes({
            path: "/{proxy+}",
            methods: [apigatewayv2.HttpMethod.ANY],
            integration: integration,
        });

        this.api.addRoutes({
            path: "/",
            methods: [apigatewayv2.HttpMethod.ANY],
            integration: integration,
        });

        // Configure access logging
        const stage = this.api.defaultStage as apigatewayv2.HttpStage;
        stage.accessLogSettings = {
            destinationArn: this.logGroup.logGroupArn,
            format: "$context.requestId $context.routeKey $context.status",
        };
    }
}
```

**Stack Integration** (`lib/benchling-webhook-stack.ts`):

```typescript
// Replace old ALB API Gateway construct
this.api = new HttpApiGateway(this, "HttpApiGateway", {
    vpc: vpc,
    cloudMapService: this.fargateService.cloudMapService,
    serviceSecurityGroup: this.fargateService.service.connections.securityGroups[0],
    config: config,
});

this.webhookEndpoint = this.api.api.url!;
```

---

### Phase 3: Update Local Docker (1h)

**Files**:

- `docker/docker-compose.yml`
- `docker/app.py`

**Changes**:

1. Update Flask port: 5000 → 8080
2. Update Docker port mapping: 5000:5000 → 8080:8080
3. Update Flask app to listen on port 8080

---

### Phase 4: Update Tests (2h)

**Files**:

- `test/benchling-webhook-stack.test.ts`
- `test/alb-api-gateway.test.ts` → `test/http-api-gateway.test.ts`

**Key Tests**:

```typescript
test("creates HTTP API instead of REST API", () => {
    template.resourceCountIs("AWS::ApiGatewayV2::Api", 1);
    template.resourceCountIs("AWS::ApiGateway::RestApi", 0);
});

test("does not create ALB", () => {
    template.resourceCountIs("AWS::ElasticLoadBalancingV2::LoadBalancer", 0);
});

test("creates single-container task definition", () => {
    template.hasResourceProperties("AWS::ECS::TaskDefinition", {
        ContainerDefinitions: Match.arrayWith([
            Match.objectLike({
                Name: "BenchlingFlaskContainer",
                PortMappings: Match.arrayWith([
                    Match.objectLike({ ContainerPort: 8080 })
                ])
            }),
        ]),
    });
});

test("creates VPC Link and Cloud Map", () => {
    template.resourceCountIs("AWS::ApiGatewayV2::VpcLink", 1);
    template.resourceCountIs("AWS::ServiceDiscovery::Service", 1);
});
```

---

### Phase 5: Documentation (1h)

**Files**:

- `MIGRATION.md` (new) - Detailed upgrade guide
- `CHANGELOG.md` - v0.9.0 entry
- `CLAUDE.md` - Architecture section update
- `README.md` - Architecture diagram + monitoring updates

**Key Sections**:

- Migration steps (destroy + redeploy)
- Webhook URL update instructions
- Port change (5000 → 8080)
- Rollback procedure
- What's removed (ALB, REST API)
- What's added (HTTP API, VPC Link, Cloud Map)

---

## Critical Files

1. **lib/fargate-service.ts** - Update Flask port to 8080, remove ALB, add Cloud Map
2. **lib/alb-api-gateway.ts** → **lib/http-api-gateway.ts** - Complete rewrite for HTTP API + VPC Link
3. **lib/benchling-webhook-stack.ts** - Orchestration updates, remove ALB references
4. **docker/app.py** - Update Flask to listen on port 8080
5. **test/benchling-webhook-stack.test.ts** - Update all assertions for new architecture

---

## Testing Strategy

### Unit Tests

```bash
npm run test:ts
```

### Integration Tests

```bash
# Local Docker with Flask on port 8080
npm run test:local

# Deploy to dev
npm run deploy:dev -- --profile test-migration --yes

# Verify containers
aws ecs describe-tasks --cluster benchling-webhook-cluster --tasks <arn>

# Test logs
npm run logs -- --profile test-migration
```

### Manual Checklist

- [ ] HTTP API created (no REST API)
- [ ] VPC Link created
- [ ] Cloud Map service created
- [ ] Single container task (HEALTHY)
- [ ] Flask responds on port 8080
- [ ] API Gateway endpoint works
- [ ] Log streams created with correct prefix
- [ ] No ALB resources
- [ ] Auto-scaling works
- [ ] Real webhook test passes

---

## Rollout Timeline

| Phase | Duration | Description |
|-------|----------|-------------|
| Development | 1 week | Phases 1-2 (core architecture) |
| Testing | 1 week | Phases 3-4 (local + tests) |
| Documentation | 2 days | Phase 5 (docs + migration guide) |
| Beta | 1 week | Test with 2-3 users |
| Production | - | Tag 0.9.0, publish to npm |

**Total**: ~2.5 weeks

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| VPC Link failures | Verify security groups, test Cloud Map DNS, detailed logs |
| Port conflicts | Update all references (Docker, CDK, tests) consistently |
| Cloud Map DNS issues | Test DNS resolution, validate TTL settings, monitor health checks |
| Performance regression | HTTP API faster than REST, no ALB/Nginx hops saves 15-25ms |

---

## Success Criteria

1. ✅ All tests pass (unit + integration)
2. ✅ Response time ≤ v0.8.x baseline (expect improvement)
3. ✅ Auto-scaling works, health checks pass
4. ✅ Container logs accessible via CLI
5. ✅ Migration guide tested end-to-end
6. ✅ No user confusion during upgrade

---

## Cost Impact

**Removed**:

- ALB: ~$20/month
- ALB data processing: ~$10/month
- ALB logs S3 storage: ~$2/month

**Added**:

- VPC Link: ~$20/month

**Net**: Approximately **$10-12/month savings**

**Additional Benefits**:

- Simpler architecture → less operational overhead
- Single container per task → lower ECS costs
- No ALB logs S3 storage costs
- Faster response times (no ALB hop, no Nginx proxy)
