# v0.9.0 Architecture Migration: Standalone → Integrated Pattern

## Executive Summary

Migrate standalone BenchlingWebhookStack from **API Gateway REST → ALB → ECS** to **API Gateway HTTP → VPC Link → Cloud Map → ECS** with Nginx sidecar. This aligns standalone with the integrated Quilt stack pattern, eliminating ALB overhead while maintaining HTTPS via API Gateway.

**Status**: Breaking changes acceptable (v0.9.0)
**Goal**: Architectural consistency + simplified infrastructure

---

## Current vs Target Architecture

### Current (v0.8.x)

```
API Gateway (REST) → ALB → ECS Fargate
                            └── Flask (port 5000)

Logs: BenchlingWebhookStack
      └── benchling-webhook/{taskId}
```

### Target (v0.9.0)

```
API Gateway (HTTP v2) → VPC Link → Cloud Map → ECS Fargate
                                                ├── Nginx (port 8080)
                                                │   └→ proxy to localhost:5001
                                                └── Flask (port 5001)

Logs: BenchlingWebhookStack
      ├── benchling/benchling/{taskId}
      └── benchling-nginx/nginx/{taskId}
```

**Rationale**:

- ALB is unnecessary overhead (API Gateway provides HTTPS)
- Matches proven integrated stack architecture
- Nginx sidecar provides consistent proxy layer
- VPC Link + Cloud Map simpler than ALB target groups
- Enables future enhancements (rate limiting, custom routing)

---

## Breaking Changes (v0.9.0)

1. **Stack Recreation Required**: REST API → HTTP API (cannot update in-place)
2. **Endpoint URL Changes**: New API Gateway URL format
3. **Log Stream Prefixes**: `benchling-webhook/` → `benchling/benchling/` + `benchling-nginx/nginx/`
4. **Container Count**: 1 → 2 containers per task
5. **Flask Port**: 5000 → 5001
6. **ALB Removed**: No direct ALB testing, all traffic via API Gateway

---

## Implementation Phases

### Phase 1: Add Nginx Sidecar Container (2h)

**File**: `lib/fargate-service.ts`

**Changes**:

1. Rename Flask container: `BenchlingFlaskContainer`
2. Change Flask port: 5000 → 5001
3. Update Flask log prefix: `benchling-webhook` → `benchling/benchling`
4. Add Nginx container:
   - Image: `nginx:1.25-alpine`
   - Port: 8080
   - Log prefix: `benchling-nginx/nginx`
   - Inline nginx.conf via environment variable
   - Proxy all traffic to `localhost:5001`
5. Set container dependency: Nginx depends on Flask `HEALTHY`

**Nginx Config**:

```nginx
events { worker_connections 1024; }
http {
    upstream flask {
        server localhost:5001;
    }
    server {
        listen 8080;
        location / {
            proxy_pass http://flask;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

---

### Phase 2: Replace ALB with Cloud Map (3h)

**File**: `lib/fargate-service.ts`

**Remove**:

- ALB (`this.loadBalancer`)
- ALB logs S3 bucket (`albLogsBucket`)
- Target group (`targetGroup`)
- HTTP listener
- ALB security groups

**Add**:

1. Cloud Map private DNS namespace: `benchling.local`
2. Update Fargate service with `cloudMapOptions`:
   - Register Nginx container (port 8080)
   - DNS record type: A
   - TTL: 30s
3. Update security group: Allow inbound 8080 from VPC CIDR
4. Export `cloudMapService` for API Gateway integration

**Interface Changes**:

```typescript
export class FargateService extends Construct {
    public readonly service: ecs.FargateService;
    // REMOVED: public readonly loadBalancer: elbv2.ApplicationLoadBalancer;
    public readonly cloudMapService: servicediscovery.Service;  // NEW
    public readonly logGroup: logs.ILogGroup;
    public readonly cluster: ecs.Cluster;
}
```

---

### Phase 3: Replace REST API with HTTP API + VPC Link (4h)

**Files**:

- Rename: `lib/alb-api-gateway.ts` → `lib/http-api-gateway.ts`
- Update: `lib/benchling-webhook-stack.ts`

**New Construct**: `lib/http-api-gateway.ts`

```typescript
export class HttpApiGateway {
    public readonly api: apigatewayv2.HttpApi;
    public readonly vpcLink: apigatewayv2.VpcLink;
    public readonly logGroup: logs.ILogGroup;

    constructor(scope, id, props: {
        vpc: ec2.IVpc;
        cloudMapService: servicediscovery.IService;
        serviceSecurityGroup: ec2.ISecurityGroup;
        config: ProfileConfig;
    }) {
        // Create access log group
        this.logGroup = new logs.LogGroup(scope, "ApiGatewayAccessLogs", {
            logGroupName: "/aws/apigateway/benchling-webhook-http",
            retention: logs.RetentionDays.ONE_WEEK,
        });

        // Create VPC Link
        this.vpcLink = new apigatewayv2.VpcLink(scope, "VpcLink", {
            vpc: props.vpc,
            securityGroups: [props.serviceSecurityGroup],
            vpcLinkName: "benchling-webhook-vpclink",
        });

        // Create HTTP API
        this.api = new apigatewayv2.HttpApi(scope, "BenchlingWebhookHttpAPI", {
            apiName: "BenchlingWebhookHttpAPI",
            description: "HTTP API for Benchling webhook integration (v0.9.0+)",
        });

        // Cloud Map integration via VPC Link
        const integration = new apigatewayv2_integrations.HttpServiceDiscoveryIntegration(
            "CloudMapIntegration",
            props.cloudMapService,
            { vpcLink: this.vpcLink }
        );

        // Add routes
        this.api.addRoutes({
            path: "/{proxy+}",
            methods: [apigatewayv2.HttpMethod.ANY],
            integration: integration,
        });

        this.api.addRoutes({
            path: "/",
            methods: [apigatewayv2.HttpMethod.ANY],
            integration: integration,
        });

        // Configure access logging
        const stage = this.api.defaultStage as apigatewayv2.HttpStage;
        stage.accessLogSettings = {
            destinationArn: this.logGroup.logGroupArn,
            format: "$context.requestId $context.routeKey $context.status",
        };
    }
}
```

**Stack Integration** (`lib/benchling-webhook-stack.ts`):

```typescript
// Replace old ALB API Gateway construct
this.api = new HttpApiGateway(this, "HttpApiGateway", {
    vpc: vpc,
    cloudMapService: this.fargateService.cloudMapService,
    serviceSecurityGroup: this.fargateService.service.connections.securityGroups[0],
    config: config,
});

this.webhookEndpoint = this.api.api.url!;
```

---

### Phase 4: Update Logs Command (2h)

**File**: `bin/commands/logs.ts`

**Changes**:

1. Query **both** stream prefixes for ECS logs:
   - Flask: `benchling/benchling`
   - Nginx: `benchling-nginx/nginx`
2. Display as separate log groups in output
3. Update `fetchLogsFromGroup()` to accept `logStreamNamePrefix` parameter
4. Update help text to mention 2-container architecture

**Example**:

```typescript
// Query Flask logs
const flaskEntries = await fetchLogsFromGroup(
    "BenchlingWebhookStack",
    region,
    since,
    limit,
    filterPattern,
    awsProfile,
    "benchling/benchling",  // NEW: stream prefix filter
);

// Query Nginx logs
const nginxEntries = await fetchLogsFromGroup(
    "BenchlingWebhookStack",
    region,
    since,
    limit,
    filterPattern,
    awsProfile,
    "benchling-nginx/nginx",  // NEW: stream prefix filter
);

// Display both
result.push({
    name: "BenchlingWebhookStack",
    displayName: "Flask Application",
    entries: flaskEntries,
});

result.push({
    name: "BenchlingWebhookStack",
    displayName: "Nginx Proxy",
    entries: nginxEntries,
});
```

---

### Phase 5: Update Local Docker (1h)

**Files**:

- `docker/docker-compose.yml`
- `docker/nginx.conf` (new)

**Changes**:

1. Update Flask port: 5000 → 5001
2. Add optional Nginx service to docker-compose
3. Create `nginx.conf` for local development

---

### Phase 6: Update Tests (3h)

**Files**:

- `test/benchling-webhook-stack.test.ts`
- `test/alb-api-gateway.test.ts` → `test/http-api-gateway.test.ts`

**Key Tests**:

```typescript
test("creates HTTP API instead of REST API", () => {
    template.resourceCountIs("AWS::ApiGatewayV2::Api", 1);
    template.resourceCountIs("AWS::ApiGateway::RestApi", 0);
});

test("does not create ALB", () => {
    template.resourceCountIs("AWS::ElasticLoadBalancingV2::LoadBalancer", 0);
});

test("creates 2-container task definition", () => {
    template.hasResourceProperties("AWS::ECS::TaskDefinition", {
        ContainerDefinitions: Match.arrayWith([
            Match.objectLike({ Name: "BenchlingFlaskContainer" }),
            Match.objectLike({ Name: "BenchlingNginxContainer" }),
        ]),
    });
});

test("creates VPC Link and Cloud Map", () => {
    template.resourceCountIs("AWS::ApiGatewayV2::VpcLink", 1);
    template.resourceCountIs("AWS::ServiceDiscovery::Service", 1);
});
```

---

### Phase 7: Documentation (2h)

**Files**:

- `MIGRATION.md` (new) - Detailed upgrade guide
- `CHANGELOG.md` - v0.9.0 entry
- `CLAUDE.md` - Architecture section update
- `README.md` - Architecture diagram + monitoring updates

**Key Sections**:

- Migration steps (destroy + redeploy)
- Webhook URL update instructions
- Log query changes
- Rollback procedure
- What's removed (ALB, REST API)
- What's added (HTTP API, VPC Link, Nginx)

---

## Critical Files

1. **lib/fargate-service.ts** - Add Nginx sidecar, update Flask port, remove ALB, add Cloud Map
2. **lib/alb-api-gateway.ts** → **lib/http-api-gateway.ts** - Complete rewrite for HTTP API + VPC Link
3. **lib/benchling-webhook-stack.ts** - Orchestration updates, remove ALB references
4. **bin/commands/logs.ts** - Handle 2 stream prefixes, update discovery logic
5. **test/benchling-webhook-stack.test.ts** - Update all assertions for new architecture

---

## Testing Strategy

### Unit Tests

```bash
npm run test:ts
```

### Integration Tests

```bash
# Local Docker with Nginx sidecar
npm run test:local

# Deploy to dev
npm run deploy:dev -- --profile test-migration --yes

# Verify containers
aws ecs describe-tasks --cluster benchling-webhook-cluster --tasks <arn>

# Test logs
npm run logs -- --profile test-migration
```

### Manual Checklist

- [ ] HTTP API created (no REST API)
- [ ] VPC Link created
- [ ] Cloud Map service created
- [ ] 2 containers per task (both HEALTHY)
- [ ] Flask responds on localhost:5001
- [ ] Nginx responds on localhost:8080
- [ ] API Gateway endpoint works
- [ ] Both log streams created
- [ ] No ALB resources
- [ ] Auto-scaling works
- [ ] Real webhook test passes

---

## Rollout Timeline

| Phase | Duration | Description |
|-------|----------|-------------|
| Development | 1 week | Phases 1-3 (core architecture) |
| Testing | 1 week | Phases 4-6 (logs, tests, local) |
| Documentation | 3 days | Phase 7 (docs + migration guide) |
| Beta | 1 week | Test with 2-3 users |
| Production | - | Tag 0.9.0, publish to npm |

**Total**: ~3 weeks

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Nginx config issues | Use proven config from integrated stack, extensive testing |
| VPC Link failures | Verify security groups, test Cloud Map DNS, detailed logs |
| Log discovery breaks | Keep log group name same, update stream prefixes, migration script |
| Container dependencies | Use `HEALTHY` condition, sufficient health check `startPeriod` |
| Performance regression | HTTP API faster than REST, Nginx <5ms, no ALB hop saves 10-20ms |

---

## Success Criteria

1. ✅ All tests pass (unit + integration)
2. ✅ Response time ≤ v0.8.x baseline
3. ✅ Auto-scaling works, health checks pass
4. ✅ Both container logs accessible via CLI
5. ✅ Migration guide tested end-to-end
6. ✅ No user confusion during upgrade

---

## Cost Impact

**Removed**:

- ALB: ~$20/month
- ALB data processing: ~$10/month

**Added**:

- VPC Link: ~$20/month
- Nginx container: ~$5/month (minimal memory)

**Net**: Approximately **cost-neutral** (~$5-10/month savings)

**Additional Benefits**:

- Simpler architecture → less operational overhead
- Consistent with integrated stack → easier maintenance
- No ALB logs S3 storage costs
- Slightly faster response times (no ALB hop)
