# New Environment Variables Propagation Audit

**Date**: 2025-11-17
**Context**: Follow-on to [14-invalid-envars-removal-checklist.md](./14-invalid-envars-removal-checklist.md)
**Purpose**: Ensure the NEW v0.8.0+ service-specific environment variables are properly propagated and used throughout the entire execution chain

---

## EXECUTIVE SUMMARY

The v0.8.0+ service-envars mechanism introduced **new optional environment variables** for Quilt services:

```typescript
// ✅ NEW v0.8.0+ service-specific envars
ATHENA_USER_WORKGROUP      // Default: "primary"
ATHENA_RESULTS_BUCKET      // Default: "" (empty)
ICEBERG_DATABASE           // Default: "" (empty)
ICEBERG_WORKGROUP          // Default: "" (empty)
```

These replace the old pattern of passing a Quilt Stack ARN and querying CloudFormation at runtime.

### Audit Scope

Need to verify these variables are:
1. ✅ Generated by `bin/xdg-launch.ts:buildEnvVars()`
2. ❓ Passed by `docker/docker-compose.yml` to containers
3. ❓ Read by `docker/src/config.py` from environment
4. ❓ Used by Flask application (if applicable)
5. ✅ Passed by `lib/fargate-service.ts` to Fargate tasks
6. ❓ Tested in integration tests

---

## DETAILED AUDIT

### 1. bin/xdg-launch.ts ✅

**Lines 188-194**: New envars are generated correctly

```typescript
// Quilt Services (v0.8.0+ service-specific - NO MORE STACK ARN!)
QUILT_WEB_HOST: config.quilt.catalog,
ATHENA_USER_DATABASE: config.quilt.database,
ATHENA_USER_WORKGROUP: config.quilt.athenaUserWorkgroup || "primary",
ATHENA_RESULTS_BUCKET: config.quilt.athenaResultsBucket || "",
ICEBERG_DATABASE: config.quilt.icebergDatabase || "",
ICEBERG_WORKGROUP: config.quilt.icebergWorkgroup || "",
PACKAGER_SQS_URL: config.quilt.queueUrl,
```

**Status**: ✅ CORRECT - All new envars are present with proper defaults

---

### 2. docker/docker-compose.yml ✅

**Need to verify**: Lines 14-21 (app service) and 63-70 (app-dev service)

Let me check the current state...

**Lines 14-21 (app service)**:
```yaml
# Quilt Services (v0.8.0+ service-specific)
- QUILT_WEB_HOST=${QUILT_WEB_HOST}
- ATHENA_USER_DATABASE=${ATHENA_USER_DATABASE}
- ATHENA_USER_WORKGROUP=${ATHENA_USER_WORKGROUP:-primary}
- ATHENA_RESULTS_BUCKET=${ATHENA_RESULTS_BUCKET:-}
- ICEBERG_DATABASE=${ICEBERG_DATABASE:-}
- ICEBERG_WORKGROUP=${ICEBERG_WORKGROUP:-}
- PACKAGER_SQS_URL=${PACKAGER_SQS_URL}
```

**Status**: ✅ CORRECT - All new envars are present with proper defaults

---

### 3. docker/src/config.py ❌

**Current State**: The new optional envars are NOT being read!

Looking at the current implementation (lines 62-66):
```python
# Read Quilt service environment variables (NO CLOUDFORMATION!)
self.quilt_catalog = os.getenv("QUILT_WEB_HOST", "")
self.quilt_database = os.getenv("ATHENA_USER_DATABASE", "")
self.queue_url = os.getenv("PACKAGER_SQS_URL", "")
self.aws_region = os.getenv("AWS_REGION", "")
self.s3_bucket_name = os.getenv("PACKAGE_BUCKET", "")  # ❌ INVALID - should be removed
```

**Missing envars**:
```python
# ❌ MISSING - These ARE used by PackageQuery but NOT read here
ATHENA_USER_WORKGROUP
ATHENA_RESULTS_BUCKET
ICEBERG_DATABASE
ICEBERG_WORKGROUP
```

**Action Required**:
- [ ] Add the new optional envars to `docker/src/config.py`
- [ ] Store them in appropriate fields
- [ ] Remove PACKAGE_BUCKET (per 14-invalid-envars-removal-checklist.md)

**Proposed Fix**:
```python
# Read Quilt service environment variables (NO CLOUDFORMATION!)
self.quilt_catalog = os.getenv("QUILT_WEB_HOST", "")
self.quilt_database = os.getenv("ATHENA_USER_DATABASE", "")
self.queue_url = os.getenv("PACKAGER_SQS_URL", "")
self.aws_region = os.getenv("AWS_REGION", "")

# Optional Quilt service configuration (v0.8.0+)
# These are used by PackageQuery for Athena/Iceberg queries
self.athena_user_workgroup = os.getenv("ATHENA_USER_WORKGROUP", "primary")
self.athena_results_bucket = os.getenv("ATHENA_RESULTS_BUCKET", "")
self.iceberg_database = os.getenv("ICEBERG_DATABASE", "")
self.iceberg_workgroup = os.getenv("ICEBERG_WORKGROUP", "")
```

**NOTE**: These envars ARE actively used by `docker/src/package_query.py` (see section 4 below)

---

### 4. docker/src/config_schema.py ❓

**Need to verify**: Do the Pydantic schemas include the new fields?

Looking at the current `BenchlingSecret` schema (lines 165-204), these are NOT included because they're NOT part of the secret - they're infrastructure configuration.

**Action Required**: NONE - These don't belong in the secret schema

However, we should verify if there's a separate config schema for infrastructure that should include these fields.

---

### 5. lib/fargate-service.ts ✅

**Lines 282-289**: New envars are passed to Fargate tasks

```typescript
// Quilt Services (v0.8.0+ service-specific - NO MORE STACK ARN!)
QUILT_WEB_HOST: props.quiltWebHost,
ATHENA_USER_DATABASE: props.athenaUserDatabase,
ATHENA_USER_WORKGROUP: props.athenaUserWorkgroup || "primary",
ATHENA_RESULTS_BUCKET: props.athenaResultsBucket || "",
ICEBERG_DATABASE: props.icebergDatabase || "",
ICEBERG_WORKGROUP: props.icebergWorkgroup || "",
PACKAGER_SQS_URL: props.packagerQueueUrl,
```

**Status**: ✅ CORRECT - All new envars are present with proper defaults

---

### 6. Flask Application Usage ✅

**CONFIRMED**: These envars ARE actively used by the Flask application!

**File**: [docker/src/package_query.py](../../docker/src/package_query.py)

#### Usage Details

**Lines 41-59**: `PackageQuery.__init__()` reads the new envars:

```python
def __init__(
    self,
    bucket: str,
    catalog_url: str,
    database: Optional[str] = None,
    region: Optional[str] = None,
    athena_output_bucket: Optional[str] = None,
    workgroup: Optional[str] = None,
):
    """Initialize Athena query client.

    Args:
        athena_output_bucket: S3 bucket for Athena query results
            (defaults to ATHENA_RESULTS_BUCKET env var, then aws-athena-query-results-{account_id}-{region})
        workgroup: Athena workgroup name (defaults to ATHENA_USER_WORKGROUP env var, then 'primary')
    """
```

**Lines 74-86**: Reads the envars with proper fallbacks:

```python
# Determine Athena workgroup (from env var or parameter, default to 'primary')
self.workgroup = workgroup or os.getenv("ATHENA_USER_WORKGROUP", "primary")

# Determine Athena output location
# Priority: parameter > ATHENA_RESULTS_BUCKET env var > default pattern
if athena_output_bucket:
    self.output_location = f"s3://{athena_output_bucket}/"
elif os.getenv("ATHENA_RESULTS_BUCKET"):
    self.output_location = f"s3://{os.getenv('ATHENA_RESULTS_BUCKET')}/"
else:
    # Get AWS account ID for default bucket
    sts = boto3.client("sts", region_name=self.region)
    account_id = sts.get_caller_identity()["Account"]
    self.output_location = f"s3://aws-athena-query-results-{account_id}-{self.region}/"
```

**Lines 115-120**: Uses workgroup in Athena query execution:

```python
response = self.athena.start_query_execution(
    QueryString=query,
    QueryExecutionContext={"Database": self.database},
    ResultConfiguration={"OutputLocation": self.output_location},
    WorkGroup=self.workgroup,  # ✅ Uses ATHENA_USER_WORKGROUP
)
```

#### Impact Analysis

1. **ATHENA_USER_WORKGROUP** (line 74):
   - Used to specify which Athena workgroup executes queries
   - Default: `"primary"`
   - Critical for multi-tenant Athena configurations

2. **ATHENA_RESULTS_BUCKET** (lines 77-86):
   - Used to specify where Athena stores query results
   - Default: `aws-athena-query-results-{account_id}-{region}`
   - Important for cost control and data organization

3. **ICEBERG_DATABASE** & **ICEBERG_WORKGROUP**:
   - NOT currently used in `package_query.py`
   - Reserved for future Iceberg table support
   - Should still be passed through for forward compatibility

#### Current State

**PackageQuery reads envars directly from `os.getenv()`** - it does NOT use the Config class!

This means:
- ✅ The envars ARE being used
- ❌ But they're NOT centralized in the Config class
- ❌ This creates inconsistency (some code uses Config, some uses os.getenv directly)

**Action Required**:
- [ ] Add these fields to `docker/src/config.py` (as proposed in section 3)
- [ ] Update `PackageQuery.__init__()` to accept these from Config instead of reading directly
- [ ] OR: Document that `PackageQuery` intentionally reads envars directly for flexibility

---

### 7. Integration Tests ❓

**Need to verify**: Do the integration tests include the new envars?

Looking at `test/integration/xdg-launch-pure-functions.test.ts`:

**Lines 128-147**: Test for optional Iceberg resources
```typescript
it("should handle optional Iceberg resources gracefully", () => {
    const envVars = buildEnvVars(defaultConfig, "native", {
        mode: "native",
        profile: "default",
        verbose: false,
        test: false,
    });

    // Iceberg resources are optional
    expect(envVars).toHaveProperty("ICEBERG_DATABASE");
    expect(envVars).toHaveProperty("ICEBERG_WORKGROUP");

    // Should be empty string if not configured
    if (!defaultConfig.quilt.icebergDatabase) {
        expect(envVars.ICEBERG_DATABASE).toBe("");
    }
    if (!defaultConfig.quilt.icebergWorkgroup) {
        expect(envVars.ICEBERG_WORKGROUP).toBe("");
    }
});
```

**Status**: ✅ PARTIAL - Iceberg envars are tested, but need to verify ATHENA_USER_WORKGROUP and ATHENA_RESULTS_BUCKET

**Action Required**:
- [ ] Add test case for `ATHENA_USER_WORKGROUP` (should default to "primary")
- [ ] Add test case for `ATHENA_RESULTS_BUCKET` (should default to "")
- [ ] Verify all new envars are tested in the integration test suite

**Proposed Test Addition**:
```typescript
it("should handle optional Athena configuration gracefully", () => {
    const envVars = buildEnvVars(defaultConfig, "native", {
        mode: "native",
        profile: "default",
        verbose: false,
        test: false,
    });

    // Athena user workgroup should default to "primary"
    expect(envVars).toHaveProperty("ATHENA_USER_WORKGROUP");
    if (!defaultConfig.quilt.athenaUserWorkgroup) {
        expect(envVars.ATHENA_USER_WORKGROUP).toBe("primary");
    }

    // Athena results bucket is optional
    expect(envVars).toHaveProperty("ATHENA_RESULTS_BUCKET");
    if (!defaultConfig.quilt.athenaResultsBucket) {
        expect(envVars.ATHENA_RESULTS_BUCKET).toBe("");
    }
});
```

---

## USAGE PATTERNS

### Where Are These Used?

The new service-specific envars enable the Flask application to interact with Quilt services WITHOUT querying CloudFormation at runtime:

1. **ATHENA_USER_WORKGROUP**: Specifies which Athena workgroup to use for user queries
   - Default: `"primary"`
   - Used when: Querying Athena for package metadata

2. **ATHENA_RESULTS_BUCKET**: Specifies where Athena query results are stored
   - Default: `""` (uses default bucket: `aws-athena-query-results-{account}-{region}`)
   - Used when: Configuring Athena query output location

3. **ICEBERG_DATABASE**: Specifies the Iceberg catalog database name
   - Default: `""` (Iceberg not used)
   - Used when: Querying Iceberg tables (if configured)

4. **ICEBERG_WORKGROUP**: Specifies which Athena workgroup to use for Iceberg queries
   - Default: `""` (Iceberg not used)
   - Used when: Querying Iceberg tables (if configured)

---

## CONFIGURATION FLOW

### v0.8.0+ Configuration Pipeline

```
XDG Config (~/.config/benchling-webhook/{profile}/config.json)
  ↓
quilt: {
  athenaUserWorkgroup: "my-workgroup",
  athenaResultsBucket: "my-results-bucket",
  icebergDatabase: "iceberg_db",
  icebergWorkgroup: "iceberg_workgroup",
}
  ↓
bin/xdg-launch.ts:buildEnvVars()
  ↓
ATHENA_USER_WORKGROUP=my-workgroup
ATHENA_RESULTS_BUCKET=my-results-bucket
ICEBERG_DATABASE=iceberg_db
ICEBERG_WORKGROUP=iceberg_workgroup
  ↓
docker-compose.yml (passes to container)
  ↓
docker/src/config.py (reads from environment)
  ↓
Flask application (uses in Athena/Iceberg queries)
```

---

## ACTION ITEMS

### Critical (Blocking)

1. **docker/src/config.py**: Add fields to read the new optional envars from environment
   - Status: ❌ NOT DONE
   - Impact: PackageQuery currently reads envars directly via `os.getenv()`, bypassing Config
   - Priority: HIGH
   - Lines to add: ~4 lines after line 66

2. **Consistency Decision**: Choose one of two approaches:
   - Option A: Add envars to Config, update PackageQuery to use Config
   - Option B: Document that PackageQuery intentionally reads envars directly for flexibility
   - Recommendation: Option A for consistency

### Important (Should Have)

3. **Integration Tests**: Add test cases for ATHENA_USER_WORKGROUP and ATHENA_RESULTS_BUCKET
   - Status: ❌ PARTIAL (Iceberg tested, Athena not tested)
   - Impact: Missing test coverage for actively-used envars
   - Priority: MEDIUM
   - File: `test/integration/xdg-launch-pure-functions.test.ts`

4. **Documentation**: Update comments in config.py to explain the new optional fields
   - Status: ❌ NOT DONE
   - Impact: Low (code is functional without it)
   - Priority: LOW

### Nice to Have

5. **Type Definitions**: Ensure TypeScript types include the new optional fields
   - Status: ✅ DONE (ProfileConfig already has these fields)
   - Priority: N/A

6. **Validation**: Add validation for workgroup/bucket name formats (if needed)
   - Status: ❓ NOT EVALUATED
   - Impact: Low (AWS will reject invalid names)
   - Priority: LOW

---

## VERIFICATION CHECKLIST

After making changes, verify:

- [ ] `npm run test:local` - Flask reads new envars correctly
- [ ] `npm run test:native` - Native mode works with new envars
- [ ] `npm run test:dev` - Deployed dev stack uses new envars
- [ ] `npm run test:integration` - Integration tests cover new envars
- [ ] Search Flask codebase for Athena/Iceberg usage patterns
- [ ] Verify IAM permissions include Athena workgroup access

---

## PRIORITY

**HIGH**: These envars are ACTIVELY USED by PackageQuery but NOT centralized in the Config class!

### Current State

- ✅ Envars are passed correctly through the chain (xdg-launch → docker-compose → container)
- ❌ Envars are NOT read into Config class
- ❌ PackageQuery reads them directly via `os.getenv()`, bypassing Config
- ❌ This creates inconsistency in how configuration is accessed

### Impact

- **Functionality**: ✅ WORKS (PackageQuery reads envars directly)
- **Architecture**: ❌ BROKEN (Config class is supposed to be the single source of truth)
- **Maintainability**: ❌ POOR (some code uses Config, some uses os.getenv directly)

### Recommendation

**Fix this AFTER completing [14-invalid-envars-removal-checklist.md](./14-invalid-envars-removal-checklist.md)**

1. First: Remove invalid envars (PACKAGE_BUCKET, etc.)
2. Then: Add new envars to Config class
3. Finally: Optionally update PackageQuery to use Config (or document the direct access pattern)

**Estimated Effort**: 1-2 hours to add fields and update tests

**Risk**: LOW - These are additive changes with safe defaults
